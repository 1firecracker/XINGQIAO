# 星桥项目功能详解

## 项目概述

星桥是一个专为特殊教育设计的场景化AI生图与行为训练系统，通过AI生成高对比度、低刺激的训练图像，辅助孤独症等特需儿童进行社交与生活技能训练。

## 用户功能

### 1. 场景训练

#### 1.1 预设场景训练
- 系统提供官方推荐场景（如：超市排队、课堂打招呼、课堂举手等）
- 每个场景包含3-5个循序渐进的训练步骤
- 用户可直接选择场景开始训练

#### 1.2 AI生成场景
- 用户输入任意训练主题（如："理发店剪头发"、"在公园滑滑梯"）
- AI自动规划3-5个训练步骤
- 每个步骤包含：
  - **指令**：6字以内的短指令（如："站到队尾"、"举起手"）
  - **图片提示词**：英文描述，用于生成训练图像

#### 1.3 训练会话
- 按步骤展示训练内容
- 每步显示AI生成的训练图像
- 支持语音引导（TTS）
- 记录每个步骤的辅助等级（F/P/I）
- 完成后显示训练反馈

### 2. 数据统计
- 查看训练历史记录
- 完成度统计
- 进度追踪图表
- 辅助等级分析

### 3. 用户设置
- 儿童昵称设置
- 兴趣偏好配置（用于个性化图片生成）
- 语音音色选择
- 背景音乐设置

## 图片生成逻辑详解

### 生成流程

```
用户输入主题 
  ↓
AI规划场景步骤（生成image_prompt）
  ↓
前端构建完整prompt
  ↓
后端调用Gemini API生成图片
  ↓
保存图片到服务器
  ↓
返回图片URL并显示
```

### 详细步骤

#### 步骤1：AI规划场景步骤

**位置**：`backend/app/ai_service.py` - `plan_scenario_steps()`

**功能**：
- 使用Google Gemini AI分析用户输入的主题
- 生成3-5个训练步骤
- 每个步骤包含：
  - `instruction`：6字以内的中文指令
  - `image_prompt`：英文图片提示词（10-15个单词）

**image_prompt格式要求**：
- 必须包含任务背景/场景上下文
- 格式：`"动作 + 任务背景"`
- 示例：
  - `"child standing at crosswalk edge"`
  - `"child turning head left to check traffic while crossing street"`
  - `"child raising hand in classroom"`

**个性化融入**：
- 如果用户设置了兴趣偏好，AI会在合适时机融入相关元素
- 例如：在场景物品上增添相关印花（不是每张图片都需要）

#### 步骤2：前端构建完整Prompt

**位置**：`frontend/src/geminiService.ts` - `generateSpecialEdImage()`

**Prompt组成**：
```javascript
完整Prompt = image_prompt + childDescriptor + PROMPT_BASE_STYLE + PROMPT_VISUAL_ANCHOR
```

**各部分说明**：

1. **image_prompt**（来自AI规划）
   - 示例：`"child standing at crosswalk edge"`

2. **childDescriptor**（儿童描述）
   - 如果有兴趣偏好：`"A small child with [兴趣]"`
   - 否则：`"A small child with a simple light-colored t-shirt"`

3. **PROMPT_BASE_STYLE**（基础风格）
   ```javascript
   "minimalist black line art, white background, low saturation colors only if needed, 
   no shading, no gradients, no textures, no clutter"
   ```
   - 极简黑色线条风格
   - 白色背景
   - 低饱和度颜色（如需要）
   - 无阴影、渐变、纹理、杂乱元素

4. **PROMPT_VISUAL_ANCHOR**（视觉锚点）
   ```javascript
   "one child or objects only, one action, neutral expression, simple shapes, 
   no decorative elements, no background people, no text, no symbols"
   ```
   - 只有一个儿童或物体
   - 单一动作
   - 中性表情
   - 简单形状
   - 无装饰元素、背景人物、文字、符号

**完整示例**：
```
"child standing at crosswalk edge, A small child with a simple light-colored t-shirt, 
minimalist black line art, white background, low saturation colors only if needed, 
no shading, no gradients, no textures, no clutter, one child or objects only, 
one action, neutral expression, simple shapes, no decorative elements, 
no background people, no text, no symbols"
```

#### 步骤3：后端调用Gemini API

**位置**：`backend/app/ai_service.py` - `generate_image()`

**API调用**：
- 模型：`gemini-3-pro-image-preview`
- 输入：完整构建的prompt
- 输出：图片数据（Base64编码或二进制）

**数据处理**：
1. 接收Gemini返回的图片数据
2. 验证图片格式（PNG格式）
3. 保存到服务器：`backend/uploads/images/`
4. 返回相对路径：`/files/images/[文件名]`

#### 步骤4：图片保存与URL返回

**位置**：`backend/app/utils/file_manager.py`

**保存逻辑**：
- 文件名：基于时间戳生成唯一文件名
- 保存路径：`uploads/images/[文件名].png`
- URL格式：`/files/images/[文件名].png`

**前端URL处理**：
- 如果是相对路径（以`/`开头），转换为完整后端URL
- 格式：`http://localhost:8000/files/images/[文件名].png`

### 图片生成特点

1. **特教适配设计**
   - 高对比度：黑色线条 + 白色背景
   - 低刺激：无复杂背景、无装饰元素
   - 视觉锚点明确：单一动作、简单形状

2. **个性化定制**
   - 根据儿童兴趣偏好融入元素
   - 儿童形象描述可定制

3. **批量生成**
   - 场景规划完成后，并行生成所有步骤的图片
   - 显示生成进度

4. **图片缓存**
   - 生成的图片保存到数据库（`TrainingStep.image_url`）
   - 下次使用相同场景时直接加载，无需重新生成

### 图片重新生成

**功能**：用户可在训练过程中重新生成某一步骤的图片

**流程**：
1. 用户点击"重新生成"按钮
2. 使用相同的prompt重新调用API
3. 更新数据库中的`image_url`
4. 刷新显示

## 技术架构

### 前端
- React 19 + TypeScript
- Vite构建工具
- Tailwind CSS样式

### 后端
- FastAPI (Python)
- SQLAlchemy ORM
- Google Gemini AI API

### 数据库
- SQLite（开发环境）
- 主要表：
  - `scenarios`：场景表
  - `training_steps`：训练步骤表
  - `training_records`：训练记录表

