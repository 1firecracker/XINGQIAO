# å›¾ç‰‡åŠ è½½é€»è¾‘åˆ†ææŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®ç»“æ„æ¦‚è§ˆ

**æ˜Ÿæ¡¥ (Star Bridge)** æ˜¯ä¸€ä¸ªç‰¹æ®Šæ•™è‚²è®­ç»ƒåº”ç”¨ï¼Œé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼š

- **å‰ç«¯**: React + TypeScript + Vite
- **åç«¯**: FastAPI + Python
- **AIæœåŠ¡**: Google Gemini API (å›¾åƒç”Ÿæˆå’ŒTTS)

### æ ¸å¿ƒæµç¨‹

1. **åœºæ™¯è§„åˆ’** â†’ AIè§„åˆ’è®­ç»ƒæ­¥éª¤
2. **å›¾ç‰‡ç”Ÿæˆ** â†’ ä¸ºæ¯ä¸ªæ­¥éª¤ç”Ÿæˆè§†è§‰å¡ç‰‡
3. **è®­ç»ƒæ‰§è¡Œ** â†’ ç”¨æˆ·æŒ‰æ­¥éª¤å®Œæˆè®­ç»ƒ

---

## ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½é€»è¾‘è¯¦è§£

### 1. å›¾ç‰‡ç”Ÿæˆæµç¨‹

#### åç«¯ç”Ÿæˆ (`backend/app/ai_service.py`)

```python
async def generate_image(self, prompt: str) -> str:
    # 1. æ„å»ºå®Œæ•´æç¤ºè¯
    full_prompt = f"{prompt}, flat vector illustration, minimalist..."
    
    # 2. è°ƒç”¨Gemini APIç”Ÿæˆå›¾ç‰‡
    response = self.client.models.generate_content(
        model="gemini-2.5-flash-image",
        contents=full_prompt
    )
    
    # 3. æå–å›¾ç‰‡æ•°æ®å¹¶ä¿å­˜åˆ°æœ¬åœ°
    image_data = part.inline_data.data
    relative_path = file_manager.save_image(image_data)
    
    # 4. è¿”å›æ–‡ä»¶URL (æ ¼å¼: /files/images/{uuid}.png)
    return file_manager.get_file_url(relative_path)
```

**å›¾ç‰‡URLæ ¼å¼**: `/files/images/{uuid}.png` (ç›¸å¯¹è·¯å¾„)

#### å‰ç«¯è°ƒç”¨ (`frontend/src/geminiService.ts`)

```typescript
export async function generateSpecialEdImage(
  promptSuffix: string, 
  preferences?: UserPreferences,
  stepId?: number,
  scenarioId?: number
): Promise<string> {
  // è°ƒç”¨åç«¯API
  const response = await aiApi.generateImage(fullPrompt, stepId, scenarioId);
  
  // è¿”å›å›¾ç‰‡URL
  return response.data.image_url; // ä¾‹å¦‚: "/files/images/xxx.png"
}
```

### 2. å›¾ç‰‡åœ¨å‰ç«¯çš„æ˜¾ç¤ºé€»è¾‘

#### ä½ç½®: `frontend/src/components/TrainingSession.tsx` (534-567è¡Œ)

```tsx
<div className="relative aspect-square w-full bg-white rounded-[2.5rem]...">
  {currentStep.imageUrl ? (
    <img 
      src={currentStep.imageUrl}  // ç›´æ¥ä½¿ç”¨URL
      className="w-full h-full object-contain animate-in zoom-in-95 duration-500" 
      alt="Step"
      onError={(e) => {
        console.error('Image load failed:', currentStep.imageUrl);
      }}
      onLoad={() => {
        // å›¾ç‰‡åŠ è½½æˆåŠŸ
      }}
    />
  ) : (
    // å¦‚æœæ²¡æœ‰imageUrlï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    <div className="w-full h-full bg-slate-50 flex items-center justify-center">
      <div className="w-8 h-8 border-4 border-stone-200 border-t-green-400 rounded-full animate-spin"></div>
    </div>
  )}
</div>
```

**å…³é”®ç‚¹**:
- âœ… **æœ‰åŠ è½½åŠ¨ç”»**: å½“ `currentStep.imageUrl` ä¸å­˜åœ¨æ—¶ï¼Œæ˜¾ç¤ºæ—‹è½¬çš„åŠ è½½åœ†åœˆ
- âœ… **å›¾ç‰‡æœ‰æ·¡å…¥åŠ¨ç”»**: `animate-in zoom-in-95 duration-500` (500msæ·¡å…¥+ç¼©æ”¾)
- âš ï¸ **æ²¡æœ‰é¢„åŠ è½½æœºåˆ¶**: å›¾ç‰‡URLå­˜åœ¨åç«‹å³æ¸²æŸ“ï¼Œä¸ç­‰å¾…å®é™…åŠ è½½å®Œæˆ

---

## âš ï¸ æ½œåœ¨é—®é¢˜åˆ†æ

### é—®é¢˜: ç‚¹å‡»"æˆ‘åšå¥½äº†,ä¸‹ä¸€æ­¥"åå¯èƒ½å‡ºç°å›¾ç‰‡å»¶è¿Ÿæ˜¾ç¤º

#### å½“å‰å®ç° (`TrainingSession.tsx` 444-452è¡Œ)

```tsx
const handleNext = () => {
  if (currentStepIndex < steps.length - 1) {
    const nextIdx = currentStepIndex + 1;
    setCurrentStepIndex(nextIdx);  // âš ï¸ ç«‹å³æ›´æ–°ç´¢å¼•
    playStepVoice(steps[nextIdx].text);
  } else {
    onFinish(steps.filter(s => s.completed).length, steps.length);
  }
};
```

#### é—®é¢˜åœºæ™¯

1. **ç”¨æˆ·ç‚¹å‡»"æˆ‘åšå¥½äº†,ä¸‹ä¸€æ­¥"**
   - `currentStepIndex` ç«‹å³ä» `0` å˜ä¸º `1`
   - Reactç«‹å³é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤º `steps[1]`

2. **å¦‚æœ `steps[1].imageUrl` å­˜åœ¨**
   - æ¸²æŸ“ `<img src={steps[1].imageUrl} />`
   - **ä½†å›¾ç‰‡å¯èƒ½è¿˜åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œæˆ–éœ€è¦ä»æœåŠ¡å™¨åŠ è½½**

3. **å¯èƒ½å‡ºç°çš„æƒ…å†µ**:
   - âœ… **æƒ…å†µA**: å›¾ç‰‡å·²ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤ºï¼ˆæ— å»¶è¿Ÿï¼‰
   - âš ï¸ **æƒ…å†µB**: å›¾ç‰‡æœªç¼“å­˜ â†’ å…ˆæ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œç„¶åå›¾ç‰‡å‡ºç°
   - âŒ **æƒ…å†µC**: å›¾ç‰‡URLé”™è¯¯ â†’ æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œç„¶åè§¦å‘ `onError`

#### ä¸ºä»€ä¹ˆä¼šå‡ºç°å»¶è¿Ÿï¼Ÿ

1. **æ²¡æœ‰å›¾ç‰‡é¢„åŠ è½½**
   - æ‰€æœ‰æ­¥éª¤çš„å›¾ç‰‡URLåœ¨è®­ç»ƒå¼€å§‹æ—¶å·²ç”Ÿæˆ
   - ä½†æµè§ˆå™¨ä¸ä¼šè‡ªåŠ¨é¢„åŠ è½½è¿™äº›å›¾ç‰‡
   - åªæœ‰å½“å‰æ­¥éª¤çš„å›¾ç‰‡è¢«åŠ è½½

2. **æµè§ˆå™¨åŠ è½½æœºåˆ¶**
   - å½“ `<img src="...">` æ¸²æŸ“æ—¶ï¼Œæµè§ˆå™¨æ‰å¼€å§‹è¯·æ±‚å›¾ç‰‡
   - å¦‚æœå›¾ç‰‡è¾ƒå¤§æˆ–ç½‘ç»œè¾ƒæ…¢ï¼Œä¼šæœ‰æ˜æ˜¾çš„åŠ è½½å»¶è¿Ÿ

3. **Reactæ¸²æŸ“æ—¶æœº**
   - `setCurrentStepIndex` æ˜¯åŒæ­¥çš„ï¼Œç«‹å³è§¦å‘é‡æ–°æ¸²æŸ“
   - ä½†å›¾ç‰‡åŠ è½½æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦ç­‰å¾…ç½‘ç»œè¯·æ±‚å®Œæˆ

---

## ğŸ” ä»£ç éªŒè¯

### æ£€æŸ¥ç‚¹1: å›¾ç‰‡URLçš„å­˜å‚¨æ—¶æœº

**ä½ç½®**: `TrainingSession.tsx` çš„ `startSessionFlow` å‡½æ•°

- âœ… å›¾ç‰‡åœ¨è®­ç»ƒå¼€å§‹å‰å·²å…¨éƒ¨ç”Ÿæˆ
- âœ… æ‰€æœ‰æ­¥éª¤çš„ `imageUrl` å·²å­˜å‚¨åœ¨ `steps` æ•°ç»„ä¸­
- âœ… åˆ‡æ¢æ­¥éª¤æ—¶ï¼Œ`currentStep.imageUrl` åº”è¯¥å·²ç»å­˜åœ¨

### æ£€æŸ¥ç‚¹2: å›¾ç‰‡åŠ è½½çŠ¶æ€

**å½“å‰å®ç°**:
```tsx
{currentStep.imageUrl ? (
  <img src={currentStep.imageUrl} ... />
) : (
  <div>åŠ è½½åŠ¨ç”»</div>
)}
```

**é—®é¢˜**: 
- åªæ£€æŸ¥ `imageUrl` æ˜¯å¦å­˜åœ¨
- **ä¸æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å®é™…åŠ è½½å®Œæˆ**
- å¦‚æœ `imageUrl` å­˜åœ¨ä½†å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä¼šä¸€ç›´æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

### æ£€æŸ¥ç‚¹3: å›¾ç‰‡é¢„åŠ è½½æœºåˆ¶

**æœç´¢ä»£ç **: æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡é¢„åŠ è½½é€»è¾‘

**ç»“è®º**: âŒ **æ²¡æœ‰é¢„åŠ è½½æœºåˆ¶**

---

## ğŸ“Š é—®é¢˜æ€»ç»“

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **åŠ è½½åŠ¨ç”»**: å½“ `imageUrl` ä¸å­˜åœ¨æ—¶ï¼Œæ˜¾ç¤ºæ—‹è½¬åŠ è½½åœ†åœˆ
2. **å›¾ç‰‡æ·¡å…¥åŠ¨ç”»**: ä½¿ç”¨ `animate-in zoom-in-95 duration-500`
3. **é”™è¯¯å¤„ç†**: æœ‰ `onError` å›è°ƒè®°å½•é”™è¯¯

### âš ï¸ å­˜åœ¨çš„é—®é¢˜

1. **æ²¡æœ‰å›¾ç‰‡é¢„åŠ è½½**
   - åˆ‡æ¢æ­¥éª¤æ—¶ï¼Œå¦‚æœå›¾ç‰‡æœªç¼“å­˜ï¼Œä¼šæœ‰åŠ è½½å»¶è¿Ÿ
   - ç”¨æˆ·ä½“éªŒ: å¯èƒ½çœ‹åˆ°åŠ è½½åŠ¨ç”» â†’ å›¾ç‰‡çªç„¶å‡ºç°

2. **æ²¡æœ‰åŠ è½½çŠ¶æ€ç®¡ç†**
   - åªæ£€æŸ¥ `imageUrl` æ˜¯å¦å­˜åœ¨
   - ä¸æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å®é™…åŠ è½½å®Œæˆ
   - å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä¼šä¸€ç›´æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

3. **æ²¡æœ‰å›¾ç‰‡ç¼“å­˜ç­–ç•¥**
   - ä¾èµ–æµè§ˆå™¨é»˜è®¤ç¼“å­˜
   - æ²¡æœ‰ä¸»åŠ¨çš„ç¼“å­˜é¢„åŠ è½½æœºåˆ¶

---

## ğŸ’¡ å»ºè®®çš„æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ·»åŠ å›¾ç‰‡é¢„åŠ è½½

```tsx
// åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œé¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
useEffect(() => {
  if (steps.length > 0 && mode === 'ACTIVE') {
    steps.forEach(step => {
      if (step.imageUrl) {
        const img = new Image();
        img.src = step.imageUrl;
      }
    });
  }
}, [steps, mode]);
```

### æ–¹æ¡ˆ2: æ·»åŠ åŠ è½½çŠ¶æ€ç®¡ç†

```tsx
const [imageLoading, setImageLoading] = useState(true);

<img 
  src={currentStep.imageUrl}
  onLoad={() => setImageLoading(false)}
  onError={() => setImageLoading(false)}
  style={{ opacity: imageLoading ? 0 : 1 }}
/>
{imageLoading && <div>åŠ è½½åŠ¨ç”»</div>}
```

### æ–¹æ¡ˆ3: åœ¨åˆ‡æ¢æ­¥éª¤å‰é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡

```tsx
const handleNext = () => {
  const nextIdx = currentStepIndex + 1;
  if (nextIdx < steps.length && steps[nextIdx].imageUrl) {
    // é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡
    const img = new Image();
    img.src = steps[nextIdx].imageUrl;
    img.onload = () => {
      // å›¾ç‰‡åŠ è½½å®Œæˆåå†åˆ‡æ¢
      setCurrentStepIndex(nextIdx);
      playStepVoice(steps[nextIdx].text);
    };
  }
};
```

---

## ğŸ¯ ç»“è®º

### å›ç­”ä½ çš„é—®é¢˜

1. **å›¾ç‰‡åŠ è½½é€»è¾‘**: 
   - å›¾ç‰‡URLå­˜å‚¨åœ¨ `steps[].imageUrl` ä¸­
   - æ¸²æŸ“æ—¶ç›´æ¥ä½¿ç”¨ `<img src={imageUrl} />`
   - æµè§ˆå™¨è‡ªåŠ¨åŠ è½½å›¾ç‰‡

2. **ç­‰å¾…åŠ è½½æ—¶çš„åŠ¨ç”»**: 
   - âœ… **æœ‰åŠ¨ç”»**: å½“ `imageUrl` ä¸å­˜åœ¨æ—¶ï¼Œæ˜¾ç¤ºæ—‹è½¬åŠ è½½åœ†åœˆ
   - âš ï¸ **ä½†ä¸å¤Ÿå®Œå–„**: å¦‚æœ `imageUrl` å­˜åœ¨ä½†å›¾ç‰‡æœªåŠ è½½å®Œæˆï¼Œä¸ä¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”»

3. **ç‚¹å‡»"æˆ‘åšå¥½äº†,ä¸‹ä¸€æ­¥"åå¯èƒ½å‡ºç°çš„é—®é¢˜**:
   - âœ… **ä¼šå‡ºç°**: å¦‚æœä¸‹ä¸€æ­¥çš„å›¾ç‰‡æœªç¼“å­˜ï¼Œä¼šå…ˆæ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œç„¶åå›¾ç‰‡æ‰å‡ºç°
   - âš ï¸ **åŸå› **: æ²¡æœ‰å›¾ç‰‡é¢„åŠ è½½æœºåˆ¶ï¼Œåˆ‡æ¢æ­¥éª¤æ—¶æ‰å¼€å§‹åŠ è½½å›¾ç‰‡
   - âš ï¸ **å½±å“**: ç”¨æˆ·ä½“éªŒå¯èƒ½ä¸å¤Ÿæµç•…ï¼Œç‰¹åˆ«æ˜¯ç½‘ç»œè¾ƒæ…¢æ—¶

### å»ºè®®

å»ºè®®å®ç°**å›¾ç‰‡é¢„åŠ è½½æœºåˆ¶**ï¼Œåœ¨è®­ç»ƒå¼€å§‹æ—¶é¢„åŠ è½½æ‰€æœ‰æ­¥éª¤çš„å›¾ç‰‡ï¼Œæˆ–è€…åœ¨åˆ‡æ¢æ­¥éª¤å‰é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡ï¼Œä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚

